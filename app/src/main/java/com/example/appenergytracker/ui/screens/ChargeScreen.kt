package com.example.appenergytracker.ui.screens

import androidx.compose.foundation.layout.*
import androidx.compose.material.icons.Icons
import androidx.compose.material.icons.filled.CardGiftcard
import androidx.compose.material.icons.filled.CheckCircle
import androidx.compose.material.icons.filled.Timer
import androidx.compose.material.icons.filled.Lock
import androidx.compose.material3.*
import androidx.compose.runtime.*
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.graphics.Color
import androidx.compose.ui.text.font.FontWeight
import androidx.compose.ui.text.style.TextAlign
import androidx.compose.ui.unit.dp
import androidx.compose.ui.unit.sp
import androidx.navigation.NavController
import androidx.lifecycle.viewmodel.compose.viewModel
import com.example.appenergytracker.viewmodel.EnergyViewModel
import kotlinx.coroutines.delay
import kotlinx.coroutines.launch

@OptIn(ExperimentalMaterial3Api::class)
@Composable
fun ChargeScreen(navController: NavController) {
    val energyViewModel: EnergyViewModel = viewModel()
    val activityTypes = listOf("ËÆÄÊõ∏", "ÈÅãÂãï", "ÂÅöÂÆ∂‰∫ã", "ÂÜ•ÊÉ≥", "ÂÖ∂‰ªñ")
    var selectedType by remember { mutableStateOf(activityTypes.first()) }
    var ratioText by remember { mutableStateOf("1.0") }
    var isTiming by remember { mutableStateOf(false) }
    var elapsedSeconds by remember { mutableStateOf(0) }
    var showResult by remember { mutableStateOf(false) }
    
    // ÂÖçË≤ªÂÖÖËÉΩÂÜ∑ÂçªÊôÇÈñìÁõ∏ÈóúÁãÄÊÖã
    var freeChargeCooldown by remember { mutableStateOf(0) } // Ââ©È§òÂÜ∑ÂçªÁßíÊï∏
    var isFreeChargeLocked by remember { mutableStateOf(false) } // ÊòØÂê¶ÈéñÂÆö
    var showFreeChargeSuccess by remember { mutableStateOf(false) } // ÊòØÂê¶È°ØÁ§∫ÊàêÂäüË®äÊÅØ

    val coroutineScope = rememberCoroutineScope()

    Scaffold(
        topBar = {
            TopAppBar(
                title = { Text("‚ö° ÂÖÖËÉΩÊ¥ªÂãï") }
            )
        }
    ) { innerPadding ->
        Column(
            modifier = Modifier
                .padding(innerPadding)
                .padding(24.dp)
                .fillMaxSize(),
            verticalArrangement = Arrangement.spacedBy(20.dp),
            horizontalAlignment = Alignment.CenterHorizontally
        ) {
            Text("ÈÅ∏ÊìáÊ¥ªÂãïÈ°ûÂûã", fontSize = 18.sp)

            // ÂÖçË≤ªÂÖÖËÉΩÊåâÈàï
            Card(
                modifier = Modifier.fillMaxWidth(),
                colors = CardDefaults.cardColors(containerColor = MaterialTheme.colorScheme.secondaryContainer)
            ) {
                Column(
                    modifier = Modifier.padding(16.dp),
                    horizontalAlignment = Alignment.CenterHorizontally,
                    verticalArrangement = Arrangement.spacedBy(8.dp)
                ) {
                    Text(
                        text = "üéÅ ÂÖçË≤ªÂÖÖËÉΩ",
                        fontSize = 16.sp,
                        fontWeight = androidx.compose.ui.text.font.FontWeight.Bold,
                        color = MaterialTheme.colorScheme.onSecondaryContainer
                    )
                    Text(
                        text = "ÁâπÊÆäÊÉÖÊ≥Å‰∏ãÂèØÁç≤Âæó 10 ÂàÜÈêòËÉΩÈáè",
                        fontSize = 12.sp,
                        color = MaterialTheme.colorScheme.onSecondaryContainer,
                        textAlign = androidx.compose.ui.text.style.TextAlign.Center
                    )
                    
                    // ÊàêÂäüË®äÊÅØ
                    if (showFreeChargeSuccess) {
                        Card(
                            colors = CardDefaults.cardColors(containerColor = Color(0xFFE8F5E8)),
                            modifier = Modifier.fillMaxWidth()
                        ) {
                            Row(
                                modifier = Modifier.padding(12.dp),
                                verticalAlignment = Alignment.CenterVertically,
                                horizontalArrangement = Arrangement.spacedBy(8.dp)
                            ) {
                                Icon(
                                    imageVector = Icons.Default.CheckCircle,
                                    contentDescription = null,
                                    tint = Color(0xFF4CAF50)
                                )
                                Text(
                                    text = "ÊàêÂäüÁç≤Âæó 10 ÂàÜÈêòËÉΩÈáèÔºÅ",
                                    color = Color(0xFF4CAF50),
                                    fontWeight = FontWeight.Medium
                                )
                            }
                        }
                    }
                    
                    // ÂÜ∑ÂçªÊôÇÈñìÈ°ØÁ§∫
                    if (isFreeChargeLocked) {
                        Card(
                            colors = CardDefaults.cardColors(containerColor = Color(0xFFFFF3E0)),
                            modifier = Modifier.fillMaxWidth()
                        ) {
                            Row(
                                modifier = Modifier.padding(12.dp),
                                verticalAlignment = Alignment.CenterVertically,
                                horizontalArrangement = Arrangement.spacedBy(8.dp)
                            ) {
                                Icon(
                                    imageVector = Icons.Default.Timer,
                                    contentDescription = null,
                                    tint = Color(0xFFFF9800)
                                )
                                Text(
                                    text = "ÂÜ∑Âçª‰∏≠Ôºö${freeChargeCooldown / 60}:${String.format("%02d", freeChargeCooldown % 60)}",
                                    color = Color(0xFFFF9800),
                                    fontWeight = FontWeight.Medium
                                )
                            }
                        }
                    }
                    
                    Button(
                        onClick = {
                            if (!isFreeChargeLocked) {
                                // Âü∑Ë°åÂÖçË≤ªÂÖÖËÉΩ
                                energyViewModel.insertCharge(
                                    activityType = "ÂÖçË≤ªÂÖÖËÉΩ",
                                    durationMinutes = 10,
                                    ratio = 1.0f
                                )
                                
                                // È°ØÁ§∫ÊàêÂäüË®äÊÅØ
                                showFreeChargeSuccess = true
                                
                                // ÂïüÂãïÂÜ∑ÂçªÊôÇÈñì
                                isFreeChargeLocked = true
                                freeChargeCooldown = 15 * 60 // 15ÂàÜÈêò = 900Áßí
                                
                                // 3ÁßíÂæåÈö±ËóèÊàêÂäüË®äÊÅØ
                                coroutineScope.launch {
                                    kotlinx.coroutines.delay(3000)
                                    showFreeChargeSuccess = false
                                }
                                
                                // ÈñãÂßãÂÄíÊï∏Ë®àÊôÇ
                                coroutineScope.launch {
                                    while (freeChargeCooldown > 0) {
                                        kotlinx.coroutines.delay(1000)
                                        freeChargeCooldown--
                                    }
                                    isFreeChargeLocked = false
                                }
                            }
                        },
                        enabled = !isFreeChargeLocked,
                        colors = ButtonDefaults.buttonColors(
                            containerColor = if (isFreeChargeLocked) 
                                MaterialTheme.colorScheme.surfaceVariant 
                            else 
                                MaterialTheme.colorScheme.primary
                        )
                    ) {
                        Icon(
                            imageVector = if (isFreeChargeLocked) Icons.Default.Lock else Icons.Default.CardGiftcard, 
                            contentDescription = null
                        )
                        Spacer(modifier = Modifier.width(8.dp))
                                                        Text(if (isFreeChargeLocked) "ÂÜ∑Âçª‰∏≠..." else "Áç≤Âæó 10 ÂàÜÈêòËÉΩÈáè")
                    }
                }
            }

            // Ê¥ªÂãï‰∏ãÊãâÈÅ∏ÂñÆ
            var expanded by remember { mutableStateOf(false) }
            Box {
                OutlinedButton(onClick = { expanded = true }) {
                    Text(selectedType)
                }
                DropdownMenu(expanded = expanded, onDismissRequest = { expanded = false }) {
                    activityTypes.forEach { type ->
                        DropdownMenuItem(
                            text = { Text(type) },
                            onClick = {
                                selectedType = type
                                expanded = false
                            }
                        )
                    }
                }
            }

            OutlinedTextField(
                value = ratioText,
                onValueChange = { ratioText = it },
                label = { Text("ÊØèÂàÜÈêòÊèõÂ§öÂ∞ëËÉΩÈáè") },
                singleLine = true
            )

            if (!isTiming) {
                Button(
                    onClick = {
                        isTiming = true
                        showResult = false
                        elapsedSeconds = 0
                        coroutineScope.launch {
                            while (isTiming) {
                                delay(1000)
                                elapsedSeconds++
                            }
                        }
                    },
                    modifier = Modifier.fillMaxWidth()
                ) {
                    Text("ÈñãÂßãË®àÊôÇ")
                }
            } else {
                Button(
                    onClick = {
                        isTiming = false
                        showResult = true
                        val ratio = ratioText.toFloatOrNull() ?: 1f
                        val minutes = (elapsedSeconds / 60f).toInt()
                        if (minutes > 0) {
                            energyViewModel.insertCharge(
                                activityType = selectedType,
                                durationMinutes = minutes,
                                ratio = ratio
                            )
                        }
                    },
                    modifier = Modifier.fillMaxWidth()
                ) {
                    Text("ÁµêÊùüË®àÊôÇ")
                }
            }

            Text("Â∑≤ÈÄ≤Ë°åÊôÇÈñìÔºö${elapsedSeconds / 60} ÂàÜ ${elapsedSeconds % 60} Áßí")

            if (showResult) {
                val ratio = ratioText.toFloatOrNull() ?: 1f
                val earned = (elapsedSeconds / 60f) * ratio
                Text("üåü Áç≤ÂæóËÉΩÈáèÔºö${"%.1f".format(earned)} ÂàÜÈêò")
            }
        }
    }
}
